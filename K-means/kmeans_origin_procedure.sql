DROP procedure "MINER"."KMEANS_BIG_PROC2" ;
create procedure "MINER"."KMEANS_BIG_PROC2" ()
LANGUAGE SQLSCRIPT

AS BEGIN
  declare i integer;
  declare dist float;
  declare itor integer;
  declare s_cnt integer;
  i := 0;
  dist := 1.0;
  itor := 0;


  c_1 = select * from "MINER"."CENTROID_BIG" c;
  tmp = select distinct iSex from "MINER"."CENSUS_BIG";  
  select count(*) into s_cnt from :tmp;
  --while (:dist > 0.01) DO
  while (:itor <= :s_cnt) DO
  point_tmp = select id, DAGE, DANCSTRY1, DANCSTRY2, IAVAIL, ICITIZEN, ICLASS, DDEPART, IDISABL1, IDISABL2, IENGLISH, IFEB55, IFERTIL, DHISPANIC, DHOUR89, DHOURS, IIMMIGR, DINCOME1, DINCOME2, DINCOME3, DINCOME4, DINCOME5, DINCOME6, DINCOME7, DINCOME8, DINDUSTRY, IKOREAN, ILANG1, ILOOKING, IMARITAL, IMAY75880, IMEANS, IMILITARY, IMOBILITY, IMOBILLIM, DOCCUP, IOTHRSERV, IPERSCARE, DPOB, DPOVERTY, DPWGT1, IRAGECHLD, DREARNING, IRELAT1, IRELAT2, IREMPLPAR, IRIDERS, IRLABOR, IROWNCHLD, DRPINCOME, IRPOB, IRRELCHLD, IRSPOUSE, IRVETSERV, ISCHOOL, ISEPT80, ISEX, ISUBFAM1, ISUBFAM2, ITMPABSNT, DTRAVTIME, IVIETNAM, DWEEK89, IWORK89, IWORKLWK, IWWII, IYEARSCH, IYEARWRK, DYRSSERV   from "MINER"."CENSUS_BIG" p where p.iSex = :itor;
  point_cluster = select id, cid from (select
   p.id as id,
c.id as cid,
  row_number() over (partition by p.id
order by  SQRT((p.DAGE - c.DAGE)*(p.DAGE - c.DAGE)+(p.DANCSTRY1 - c.DANCSTRY1)*(p.DANCSTRY1 - c.DANCSTRY1)+(p.DANCSTRY2 - c.DANCSTRY2)*(p.DANCSTRY2 - c.DANCSTRY2)+(p.IAVAIL - c.IAVAIL)*(p.IAVAIL - c.IAVAIL)+(p.ICITIZEN - c.ICITIZEN)*(p.ICITIZEN - c.ICITIZEN)+(p.ICLASS - c.ICLASS)*(p.ICLASS - c.ICLASS)+(p.DDEPART - c.DDEPART)*(p.DDEPART - c.DDEPART)+(p.IDISABL1 - c.IDISABL1)*(p.IDISABL1 - c.IDISABL1)+(p.IDISABL2 - c.IDISABL2)*(p.IDISABL2 - c.IDISABL2)+(p.IENGLISH - c.IENGLISH)*(p.IENGLISH - c.IENGLISH)+(p.IFEB55 - c.IFEB55)*(p.IFEB55 - c.IFEB55)+(p.IFERTIL - c.IFERTIL)*(p.IFERTIL - c.IFERTIL)+(p.DHISPANIC - c.DHISPANIC)*(p.DHISPANIC - c.DHISPANIC)+(p.DHOUR89 - c.DHOUR89)*(p.DHOUR89 - c.DHOUR89)+(p.DHOURS - c.DHOURS)*(p.DHOURS - c.DHOURS)+(p.IIMMIGR - c.IIMMIGR)*(p.IIMMIGR - c.IIMMIGR)+(p.DINCOME1 - c.DINCOME1)*(p.DINCOME1 - c.DINCOME1)+(p.DINCOME2 - c.DINCOME2)*(p.DINCOME2 - c.DINCOME2)+(p.DINCOME3 - c.DINCOME3)*(p.DINCOME3- c.DINCOME3)+(p.DINCOME4 - c.DINCOME4)*(p.DINCOME4 - c.DINCOME4)+(p.DINCOME5 - c.DINCOME5)*(p.DINCOME5 - c.DINCOME5)+(p.DINCOME6 - c.DINCOME6)*(p.DINCOME6 - c.DINCOME6)+(p.DINCOME7 - c.DINCOME7)*(p.DINCOME7 - c.DINCOME7)+(p.DINCOME8 - c.DINCOME8)*(p.DINCOME8 - c.DINCOME8)+(p.DINDUSTRY - c.DINDUSTRY)*(p.DINDUSTRY - c.DINDUSTRY)+(p.IKOREAN - c.IKOREAN)*(p.IKOREAN - c.IKOREAN)+(p.ILANG1 - c.ILANG1)*(p.ILANG1 - c.ILANG1)+(p.ILOOKING - c.ILOOKING)*(p.ILOOKING - c.ILOOKING)+(p.IMARITAL - c.IMARITAL)*(p.IMARITAL - c.IMARITAL)+(p.IMAY75880 - c.IMAY75880)*(p.IMAY75880 - c.IMAY75880)+(p.IMEANS - c.IMEANS)*(p.IMEANS - c.IMEANS)+(p.IMILITARY - c.IMILITARY)*(p.IMILITARY - c.IMILITARY)+(p.IMOBILITY -c.IMOBILITY)*(p.IMOBILITY - c.IMOBILITY)+(p.IMOBILLIM - c.IMOBILLIM)*(p.IMOBILLIM - c.IMOBILLIM)+(p.DOCCUP - c.DOCCUP)*(p.DOCCUP - c.DOCCUP)+(p.IOTHRSERV - c.IOTHRSERV)*(p.IOTHRSERV - c.IOTHRSERV)+(p.IPERSCARE - c.IPERSCARE)*(p.IPERSCARE - c.IPERSCARE)+(p.DPOB - c.DPOB)*(p.DPOB - c.DPOB)+(p.DPOVERTY - c.DPOVERTY)*(p.DPOVERTY - c.DPOVERTY)+(p.DPWGT1 - c.DPWGT1)*(p.DPWGT1 - c.DPWGT1)+(p.IRAGECHLD - c.IRAGECHLD)*(p.IRAGECHLD - c.IRAGECHLD)+(p.DREARNING - c.DREARNING)*(p.DREARNING - c.DREARNING)+(p.IRELAT1 - c.IRELAT1)*(p.IRELAT1 - c.IRELAT1)+(p.IRELAT2 - c.IRELAT2)*(p.IRELAT2 - c.IRELAT2)+(p.IREMPLPAR - c.IREMPLPAR)*(p.IREMPLPAR - c.IREMPLPAR)+(p.IRIDERS - c.IRIDERS)*(p.IRIDERS - c.IRIDERS)+(p.IRLABOR - c.IRLABOR)*(p.IRLABOR - c.IRLABOR)+(p.IROWNCHLD - c.IROWNCHLD)*(p.IROWNCHLD - c.IROWNCHLD)+(p.DRPINCOME - c.DRPINCOME)*(p.DRPINCOME - c.DRPINCOME)+(p.IRPOB - c.IRPOB)*(p.IRPOB - c.IRPOB)+(p.IRRELCHLD - c.IRRELCHLD)*(p.IRRELCHLD - c.IRRELCHLD)+(p.IRSPOUSE - c.IRSPOUSE)*(p.IRSPOUSE - c.IRSPOUSE)+(p.IRVETSERV - c.IRVETSERV)*(p.IRVETSERV - c.IRVETSERV)+(p.ISCHOOL - c.ISCHOOL)*(p.ISCHOOL - c.ISCHOOL)+(p.ISEPT80 - c.ISEPT80)*(p.ISEPT80 - c.ISEPT80)+(p.ISEX - c.ISEX)*(p.ISEX - c.ISEX)+(p.ISUBFAM1 - c.ISUBFAM1)*(p.ISUBFAM1 - c.ISUBFAM1)+(p.ISUBFAM2 - c.ISUBFAM2)*(p.ISUBFAM2 - c.ISUBFAM2)+(p.ITMPABSNT - c.ITMPABSNT)*(p.ITMPABSNT - c.ITMPABSNT)+(p.DTRAVTIME - c.DTRAVTIME)*(p.DTRAVTIME - c.DTRAVTIME)+(p.IVIETNAM - c.IVIETNAM)*(p.IVIETNAM - c.IVIETNAM)+(p.DWEEK89 - c.DWEEK89)*(p.DWEEK89 - c.DWEEK89)+(p.IWORK89 - c.IWORK89)*(p.IWORK89 - c.IWORK89)+(p.IWORKLWK - c.IWORKLWK)*(p.IWORKLWK - c.IWORKLWK)+(p.IWWII -c.IWWII)*(p.IWWII - c.IWWII)+(p.IYEARSCH - c.IYEARSCH)*(p.IYEARSCH - c.IYEARSCH)+(p.IYEARWRK - c.IYEARWRK)*(p.IYEARWRK - c.IYEARWRK)+(p.DYRSSERV - c.DYRSSERV)))
as RN
 from :c_1 c,
:point_tmp p) where rn =1;

 point_2 = select p.id, pc.cid, p.DAGE, p.DANCSTRY1, p.DANCSTRY2, p.IAVAIL, p.ICITIZEN, p.ICLASS, p.DDEPART, p.IDISABL1, p.IDISABL2, p.IENGLISH, p.IFEB55, p.IFERTIL, p.DHISPANIC, p.DHOUR89, p.DHOURS, p.IIMMIGR, p.DINCOME1, p.DINCOME2, p.DINCOME3, p.DINCOME4, p.DINCOME5, p.DINCOME6, p.DINCOME7, p.DINCOME8, p.DINDUSTRY, p.IKOREAN, p.ILANG1, p.ILOOKING, p.IMARITAL, p.IMAY75880, p.IMEANS, p.IMILITARY, p.IMOBILITY, p.IMOBILLIM, p.DOCCUP, p.IOTHRSERV, p.IPERSCARE, p.DPOB, p.DPOVERTY, p.DPWGT1, p.IRAGECHLD, p.DREARNING, p.IRELAT1, p.IRELAT2, p.IREMPLPAR, p.IRIDERS, p.IRLABOR, p.IROWNCHLD, p.DRPINCOME, p.IRPOB, p.IRRELCHLD, p.IRSPOUSE, p.IRVETSERV, p.ISCHOOL, p.ISEPT80, p.ISEX, p.ISUBFAM1, p.ISUBFAM2, p.ITMPABSNT, p.DTRAVTIME, p.IVIETNAM, p.DWEEK89, p.IWORK89, p.IWORKLWK, p.IWWII, p.IYEARSCH, p.IYEARWRK, p.DYRSSERV   from :point_tmp p, :point_cluster pc where p.id = pc.id; 
  c_prev = select * from :c_1;
  
  c_1 = select * from :c_1 union
  (select cid as id, avg(DAGE) as DAGE , avg(DANCSTRY1) as DANCSTRY1 , avg(DANCSTRY2) as DANCSTRY2 , avg(IAVAIL) as IAVAIL , avg(ICITIZEN) as ICITIZEN , avg(ICLASS) as ICLASS , avg(DDEPART) as DDEPART , avg(IDISABL1) as IDISABL1 , avg(IDISABL2) as IDISABL2 , avg(IENGLISH) as IENGLISH , avg(IFEB55) as IFEB55 , avg(IFERTIL) as IFERTIL , avg(DHISPANIC) as DHISPANIC , avg(DHOUR89) as DHOUR89 , avg(DHOURS) as DHOURS , avg(IIMMIGR) as IIMMIGR , avg(DINCOME1) as DINCOME1 , avg(DINCOME2) as DINCOME2 , avg(DINCOME3) as DINCOME3 , avg(DINCOME4) as DINCOME4 , avg(DINCOME5) as DINCOME5 , avg(DINCOME6) as DINCOME6 , avg(DINCOME7) as DINCOME7 , avg(DINCOME8) as DINCOME8 , avg(DINDUSTRY) as DINDUSTRY , avg(IKOREAN) as IKOREAN , avg(ILANG1) as ILANG1 , avg(ILOOKING) as ILOOKING , avg(IMARITAL) as IMARITAL , avg(IMAY75880) as IMAY75880 , avg(IMEANS) as IMEANS , avg(IMILITARY) as IMILITARY , avg(IMOBILITY) as IMOBILITY , avg(IMOBILLIM) as IMOBILLIM , avg(DOCCUP) as DOCCUP , avg(IOTHRSERV) as IOTHRSERV , avg(IPERSCARE) as IPERSCARE , avg(DPOB) as DPOB , avg(DPOVERTY) as DPOVERTY , avg(DPWGT1) as DPWGT1 , avg(IRAGECHLD) as IRAGECHLD , avg(DREARNING) as DREARNING , avg(IRELAT1) as IRELAT1 , avg(IRELAT2) as IRELAT2 , avg(IREMPLPAR) as IREMPLPAR , avg(IRIDERS) as IRIDERS , avg(IRLABOR) as IRLABOR , avg(IROWNCHLD) as IROWNCHLD , avg(DRPINCOME) as DRPINCOME , avg(IRPOB) as IRPOB , avg(IRRELCHLD) as IRRELCHLD , avg(IRSPOUSE) as IRSPOUSE , avg(IRVETSERV) as IRVETSERV , avg(ISCHOOL) as ISCHOOL , avg(ISEPT80) as ISEPT80 , avg(ISEX) as ISEX , avg(ISUBFAM1) as ISUBFAM1 , avg(ISUBFAM2) as ISUBFAM2 , avg(ITMPABSNT) as ITMPABSNT , avg(DTRAVTIME) as DTRAVTIME , avg(IVIETNAM) as IVIETNAM , avg(DWEEK89) as DWEEK89 , avg(IWORK89) as IWORK89 , avg(IWORKLWK) as IWORKLWK , avg(IWWII) as IWWII , avg(IYEARSCH) as IYEARSCH , avg(IYEARWRK) as IYEARWRK , avg(DYRSSERV) as DYRSSERV  from :point_2 p group by cid);
  select  SUM ( (prev.DAGE - cur.DAGE) *(prev.DAGE - cur.DAGE) +(prev.DANCSTRY1 - cur.DANCSTRY1) *(prev.DANCSTRY1 - cur.DANCSTRY1) +(prev.DANCSTRY2 - cur.DANCSTRY2) *(prev.DANCSTRY2 - cur.DANCSTRY2) +(prev.IAVAIL - cur.IAVAIL) *(prev.IAVAIL - cur.IAVAIL) +(prev.ICITIZEN - cur.ICITIZEN) *(prev.ICITIZEN - cur.ICITIZEN) +(prev.ICLASS - cur.ICLASS) *(prev.ICLASS - cur.ICLASS) +(prev.DDEPART - cur.DDEPART) *(prev.DDEPART - cur.DDEPART) +(prev.IDISABL1 - cur.IDISABL1) *(prev.IDISABL1 - cur.IDISABL1) +(prev.IDISABL2 - cur.IDISABL2) *(prev.IDISABL2 - cur.IDISABL2) +(prev.IENGLISH - cur.IENGLISH) *(prev.IENGLISH - cur.IENGLISH) +(prev.IFEB55 - cur.IFEB55) *(prev.IFEB55 - cur.IFEB55) +(prev.IFERTIL - cur.IFERTIL) *(prev.IFERTIL - cur.IFERTIL) +(prev.DHISPANIC - cur.DHISPANIC) *(prev.DHISPANIC - cur.DHISPANIC) +(prev.DHOUR89 - cur.DHOUR89) *(prev.DHOUR89 - cur.DHOUR89) +(prev.DHOURS - cur.DHOURS) *(prev.DHOURS - cur.DHOURS) +(prev.IIMMIGR - cur.IIMMIGR) *(prev.IIMMIGR - cur.IIMMIGR) +(prev.DINCOME1 - cur.DINCOME1) *(prev.DINCOME1 - cur.DINCOME1) +(prev.DINCOME2 - cur.DINCOME2) *(prev.DINCOME2 - cur.DINCOME2) +(prev.DINCOME3 - cur.DINCOME3) *(prev.DINCOME3 - cur.DINCOME3) +(prev.DINCOME4 - cur.DINCOME4) *(prev.DINCOME4 - cur.DINCOME4) +(prev.DINCOME5 - cur.DINCOME5) *(prev.DINCOME5 - cur.DINCOME5) +(prev.DINCOME6 - cur.DINCOME6) *(prev.DINCOME6 - cur.DINCOME6) +(prev.DINCOME7 - cur.DINCOME7) *(prev.DINCOME7 - cur.DINCOME7) +(prev.DINCOME8 - cur.DINCOME8) *(prev.DINCOME8 - cur.DINCOME8) +(prev.DINDUSTRY - cur.DINDUSTRY) *(prev.DINDUSTRY - cur.DINDUSTRY) +(prev.IKOREAN - cur.IKOREAN) *(prev.IKOREAN - cur.IKOREAN) +(prev.ILANG1 - cur.ILANG1) *(prev.ILANG1 - cur.ILANG1) +(prev.ILOOKING - cur.ILOOKING) *(prev.ILOOKING - cur.ILOOKING) +(prev.IMARITAL - cur.IMARITAL) *(prev.IMARITAL - cur.IMARITAL) +(prev.IMAY75880 - cur.IMAY75880) *(prev.IMAY75880 - cur.IMAY75880) +(prev.IMEANS - cur.IMEANS) *(prev.IMEANS - cur.IMEANS) +(prev.IMILITARY - cur.IMILITARY) *(prev.IMILITARY - cur.IMILITARY) +(prev.IMOBILITY - cur.IMOBILITY) *(prev.IMOBILITY - cur.IMOBILITY) +(prev.IMOBILLIM - cur.IMOBILLIM) *(prev.IMOBILLIM - cur.IMOBILLIM) +(prev.DOCCUP- cur.DOCCUP) *(prev.DOCCUP - cur.DOCCUP) +(prev.IOTHRSERV - cur.IOTHRSERV) *(prev.IOTHRSERV - cur.IOTHRSERV) +(prev.IPERSCARE - cur.IPERSCARE) *(prev.IPERSCARE - cur.IPERSCARE) +(prev.DPOB - cur.DPOB) *(prev.DPOB - cur.DPOB) +(prev.DPOVERTY - cur.DPOVERTY) *(prev.DPOVERTY - cur.DPOVERTY) +(prev.DPWGT1 - cur.DPWGT1) *(prev.DPWGT1 - cur.DPWGT1) +(prev.IRAGECHLD - cur.IRAGECHLD) *(prev.IRAGECHLD - cur.IRAGECHLD) +(prev.DREARNING - cur.DREARNING) *(prev.DREARNING - cur.DREARNING) +(prev.IRELAT1 - cur.IRELAT1) *(prev.IRELAT1 - cur.IRELAT1) +(prev.IRELAT2 - cur.IRELAT2) *(prev.IRELAT2 - cur.IRELAT2) +(prev.IREMPLPAR - cur.IREMPLPAR) *(prev.IREMPLPAR - cur.IREMPLPAR) +(prev.IRIDERS - cur.IRIDERS) *(prev.IRIDERS - cur.IRIDERS) +(prev.IRLABOR - cur.IRLABOR) *(prev.IRLABOR - cur.IRLABOR) +(prev.IROWNCHLD - cur.IROWNCHLD) *(prev.IROWNCHLD - cur.IROWNCHLD) +(prev.DRPINCOME - cur.DRPINCOME) *(prev.DRPINCOME - cur.DRPINCOME) +(prev.IRPOB - cur.IRPOB) *(prev.IRPOB - cur.IRPOB) +(prev.IRRELCHLD - cur.IRRELCHLD) *(prev.IRRELCHLD - cur.IRRELCHLD) +(prev.IRSPOUSE - cur.IRSPOUSE) *(prev.IRSPOUSE - cur.IRSPOUSE) +(prev.IRVETSERV - cur.IRVETSERV) *(prev.IRVETSERV - cur.IRVETSERV) +(prev.ISCHOOL - cur.ISCHOOL) *(prev.ISCHOOL - cur.ISCHOOL) +(prev.ISEPT80 - cur.ISEPT80) *(prev.ISEPT80 - cur.ISEPT80) +(prev.ISEX - cur.ISEX) *(prev.ISEX - cur.ISEX) +(prev.ISUBFAM1 - cur.ISUBFAM1) *(prev.ISUBFAM1 - cur.ISUBFAM1) +(prev.ISUBFAM2 - cur.ISUBFAM2) *(prev.ISUBFAM2 - cur.ISUBFAM2) +(prev.ITMPABSNT - cur.ITMPABSNT) *(prev.ITMPABSNT - cur.ITMPABSNT) +(prev.DTRAVTIME - cur.DTRAVTIME) *(prev.DTRAVTIME - cur.DTRAVTIME) +(prev.IVIETNAM - cur.IVIETNAM) *(prev.IVIETNAM - cur.IVIETNAM) +(prev.DWEEK89 - cur.DWEEK89) *(prev.DWEEK89 - cur.DWEEK89) +(prev.IWORK89 - cur.IWORK89) *(prev.IWORK89 - cur.IWORK89) +(prev.IWORKLWK - cur.IWORKLWK) *(prev.IWORKLWK - cur.IWORKLWK) +(prev.IWWII - cur.IWWII) *(prev.IWWII -cur.IWWII) +(prev.IYEARSCH - cur.IYEARSCH) *(prev.IYEARSCH - cur.IYEARSCH) +(prev.IYEARWRK - cur.IYEARWRK) *(prev.IYEARWRK - cur.IYEARWRK) +(prev.DYRSSERV - cur.DYRSSERV)*(prev.DYRSSERV - cur.DYRSSERV) )  into dist from :c_prev prev, :c_1 cur where prev.id = cur.id;
  select :dist from dummy;
  itor = :itor + 1;
  END WHILE;
  select * from :c_1 WHERE ISEX = 1;
--  end while;
END;



delete from "MINER"."TIMER";
delete from "MINER"."CENTROID_BIG";
insert into "MINER"."CENTROID_BIG"(id, DAGE, DANCSTRY1, DANCSTRY2, IAVAIL, ICITIZEN, ICLASS, DDEPART, IDISABL1, IDISABL2, IENGLISH, IFEB55, IFERTIL, DHISPANIC, DHOUR89, DHOURS, IIMMIGR, DINCOME1, DINCOME2, DINCOME3, DINCOME4, DINCOME5, DINCOME6, DINCOME7, DINCOME8, DINDUSTRY, IKOREAN, ILANG1, ILOOKING, IMARITAL, IMAY75880, IMEANS, IMILITARY, IMOBILITY, IMOBILLIM, DOCCUP, IOTHRSERV, IPERSCARE, DPOB, DPOVERTY, DPWGT1, IRAGECHLD, DREARNING, IRELAT1, IRELAT2, IREMPLPAR, IRIDERS, IRLABOR, IROWNCHLD, DRPINCOME, IRPOB, IRRELCHLD, IRSPOUSE, IRVETSERV, ISCHOOL, ISEPT80, ISEX, ISUBFAM1, ISUBFAM2, ITMPABSNT, DTRAVTIME, IVIETNAM, DWEEK89, IWORK89, IWORKLWK, IWWII, IYEARSCH, IYEARWRK, DYRSSERV  ) select id, DAGE, DANCSTRY1, DANCSTRY2, IAVAIL, ICITIZEN, ICLASS, DDEPART, IDISABL1, IDISABL2, IENGLISH, IFEB55, IFERTIL, DHISPANIC, DHOUR89, DHOURS, IIMMIGR, DINCOME1, DINCOME2, DINCOME3, DINCOME4, DINCOME5, DINCOME6, DINCOME7, DINCOME8, DINDUSTRY, IKOREAN, ILANG1, ILOOKING, IMARITAL, IMAY75880, IMEANS, IMILITARY, IMOBILITY, IMOBILLIM, DOCCUP, IOTHRSERV, IPERSCARE, DPOB, DPOVERTY, DPWGT1, IRAGECHLD, DREARNING, IRELAT1, IRELAT2, IREMPLPAR, IRIDERS, IRLABOR, IROWNCHLD, DRPINCOME, IRPOB, IRRELCHLD, IRSPOUSE, IRVETSERV, ISCHOOL, ISEPT80, ISEX, ISUBFAM1, ISUBFAM2, ITMPABSNT, DTRAVTIME, IVIETNAM, DWEEK89, IWORK89, IWORKLWK, IWWII, IYEARSCH, IYEARWRK, DYRSSERV   from "MINER"."CENSUS_BIG" limit 100;
insert into "MINER"."TIMER" values('a', CURRENT_TIMESTAMP);

CALL "MINER"."KMEANS_BIG_PROC2"() WITH HINT(SQLSCRIPT_PLAN_PROFILER);

insert into "MINER"."TIMER" values('a', CURRENT_TIMESTAMP);